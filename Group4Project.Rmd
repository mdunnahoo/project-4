---
title: "English Premier League Monte Carlo Analysis"
author: "Megan Dunnahoo, Jasmine DeMeyer, Macey Dodd"
date: "12/16/2021"
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(cowplot)
set.seed(400)
```

# Article 

We chose the article "Using Monte Carlo Simulation to Calculate Match Importance:
The Case of English Premier League" by Jiri Lahvicka. This article describes the process of using Monte Carlo simulations to predict the outcome of a match given the results of previous matches. It specifically predicts the result of the Manchester City versus the Manchester United game in 2012. It then goes further and uses Monte Carlo simulations to predict the final ranking of the teams in the English Premier League at the end of a season. 

# Background Information

The English Premier League is regarded as the most popular sports league in the world due to its massive audience views and impressive revenue. There are 20 teams in the English Premier League. Manchester United is considered to be the most popular football club with the Liverpool club in second. In football, a game can result in a tie as well as a win or a loss. Three points are awarded for a win, one for a draw and zero for a loss. At the end of each season, the lowest ranking three teams will be “relegated” or demoted to the lower football league, the English Football League (EFL). The highest three ranking clubs in the English Football League will be “promoted” into the Premier League.   

# Data and Code Setup

We got our data from football-data.co.uk. We wanted to use the specific variables FTR, FTAG, and FTHG, along with the identifier variables of Date, Away Team, and Home Team. There were no NA values in any of our selected variables.   
We used four seasons ranging from years 2011-2015. Each team played 19 away games and 19 home games.   
We created functions to get the points scored and the outcome of the team for each team over the four years, specifying away or home games.


```{r data, include=FALSE}
S11_12 <- read.csv("2011-2012_Match.csv")
S12_13 <- read.csv("2012-2013_Match.csv")
S13_14 <- read.csv("2013-2014_Match.csv")
S14_15 <- read.csv("2014-2015_Match.csv")
```


```{r data_manip, include=FALSE}

# Keep only necessary columns
S11_12 <- S11_12[,2:7]
S12_13 <- S12_13[,2:7]
S13_14 <- S13_14[,2:7]
S14_15 <- S14_15[,2:7]

# Add id to keep order
S11_12$Id <- seq(1:nrow(S11_12))
S12_13$Id <- seq(381,760)
S13_14$Id <- seq(761,1140)
S14_15$Id <- seq(1141,1520)

Away_Function <- function(team_name) {
  
  # Subset and combine away team matches
  away <- S11_12[S11_12$AwayTeam == team_name,]
  away <- rbind(away, S12_13[S12_13$AwayTeam == team_name,])
  away <- rbind(away, S13_14[S13_14$AwayTeam == team_name,])
  away <- rbind(away, S14_15[S14_15$AwayTeam == team_name,])
  
  # Create new columns
  away$num_points <- rep(NA, length(away$FTR))
  away$outcome <- rep(NA, length(away$FTR))
  
  # Fill new columns
  for (i in 1:length(away$num_points)) {
    if (away$FTR[i] == "A") {
      away$num_points[i] <- 3
      away$outcome[i] <- "W"
    }
    if (away$FTR[i] == "H") {
      away$num_points[i] <- 0
      away$outcome[i] <- "L"
    }
    if (away$FTR[i] == "D") {
      away$num_points[i] <- 1
      away$outcome[i] <- "D"
    }
  }
  return(away)
}

Home_Function <- function(team_name) {
  
  # Subset and combine home team matches
  home <- S11_12[S11_12$HomeTeam == team_name,]
  home <- rbind(home, S12_13[S12_13$HomeTeam == team_name,])
  home <- rbind(home, S13_14[S13_14$HomeTeam == team_name,])
  home <- rbind(home, S14_15[S14_15$HomeTeam == team_name,])
  
  # Create new columns
  home$num_points <- rep(NA, length(home$FTR))
  home$outcome <- rep(NA, length(home$FTR))
  
  # Fill new columns
  for (i in 1:length(home$num_points)) {
    if (home$FTR[i] == "A") {
      home$num_points[i] <- 0
      home$outcome[i] <- "L"
    }
    if (home$FTR[i] == "H") {
      home$num_points[i] <- 3
      home$outcome[i] <- "W"
    }
    if (home$FTR[i] == "D") {
      home$num_points[i] <- 1
      home$outcome[i] <- "D"
    }
  }
  return(home)
}

teams <- unique(S11_12$HomeTeam)
for(i in teams) {
  nam_h <- paste(i, "Home", sep = "_")
  assign(nam_h, Home_Function(i))
  nam_a <- paste(i, "Away", sep = "_")
  assign(nam_a, Away_Function(i))
}

```


```{r mc, include=FALSE}
away_df2 <- rbind(Arsenal_Away,`Aston Villa_Away`,Blackburn_Away,Bolton_Away,Chelsea_Away,Everton_Away,Fulham_Away, Liverpool_Away,`Man City_Away`,`Man United_Away`,Newcastle_Away,Norwich_Away,QPR_Away,Stoke_Away,Sunderland_Away, Swansea_Away,Tottenham_Away,`West Brom_Away`,Wigan_Away,Wolves_Away)

away_df2 %>% group_by(AwayTeam)

home_df2 <- rbind(Arsenal_Home,`Aston Villa_Home`,Blackburn_Home,Bolton_Home,Chelsea_Home,Everton_Home,Fulham_Home, Liverpool_Home,`Man City_Home`,`Man United_Home`,Newcastle_Home,Norwich_Home,QPR_Home,Stoke_Home,Sunderland_Home, Swansea_Home,Tottenham_Home,`West Brom_Home`,Wigan_Home,Wolves_Home)

home_df2 %>% group_by(HomeTeam)


mc_funct <- function(match_id, away_team, home_team) {
  home_df_tail <- home_df2 %>% filter(Id < match_id) %>% group_by(HomeTeam) %>% do(tail(., 19))
  away_df_tail <- away_df2 %>% filter(Id < match_id) %>% group_by(AwayTeam) %>% do(tail(., 19))
  
  home_t <- home_df_tail[home_df_tail$HomeTeam==home_team,]
  avg_goalsh <- sum(home_t$FTHG, 19)/19
  avg_goals_concededh <- sum(home_t$FTAG, 19)/19
  
  away_t <- away_df_tail[away_df_tail$AwayTeam==away_team,]
  avg_goalsa <- sum(away_t$FTAG, 19)/19
  avg_goals_concededa <- sum(away_t$FTHG, 19)/19
  
  lam_home_val <- (avg_goalsh + avg_goals_concededa)/2 
  lam_away_val <- (avg_goalsa + avg_goals_concededh)/2
  
  m <- 100000
  matches <- data.frame(Home=rep(NA,m), Away=rep(NA,m), ResultH=rep(NA,m), ResultA=rep(NA,m))
  for (i in 1:m) {
    home_goals <- rpois(1,lam_home_val)
    away_goals <- rpois(1,lam_away_val)
    matches[i,1] <- home_goals
    matches[i,2] <- away_goals
    if (home_goals > away_goals) {
      matches[i,3] <- "Win"
      matches[i,4] <- "Loss"
    }
    if (home_goals < away_goals) {
      matches[i,3] <- "Loss"
      matches[i,4] <- "Win"
    }
    if (home_goals == away_goals) {
      matches[i,3] <- "Draw"
      matches[i,4] <- "Draw"
    }
  }
  matches[,3] <- as.factor(matches[,3])
  matches[,4] <- as.factor(matches[,4])
  return(matches)
}

```

# Monte Carlo Estimation

We estimated the lambda home and lambda away values, which are the expected goals scored by the home and away team respectively, using Monte Carlo. These lambda values are assumed to be independent Poisson distributed variables and are calculated using the last 19 matches for each team. The article ran 10,000,000 simulations, but due to our low computational power, we chose to run 100,000 simulations. The general purpose of Monte Carlo is to model the probability of different outcomes and reduce uncertainty. It is very useful for modeling probabilities that come from processes in which random variables intervene with each other making them difficult to predict. The purpose of the paper's Monte Carlo simulations is to devise a new way to calculate match importance which refers to the relationship between match results and the final outcome for a specific season. 

$\lambda_{home}=\frac{\text{Average goals scored by home team + Average goals conceded by away team}}{2}$   
$\lambda_{away}=\frac{\text{Average goals scored by away team + Average goals conceded by home team}}{2}$

# Replication From Article

## Manchester City (Home) vs Manchester United (Away) 4/30/2012

### Exploratory Plot of Outcomes Before Match

```{r graph0, echo=FALSE}
man1 <- Home_Function("Man City")
man1$Date <- as.Date(man1$Date, "%d/%m/%y")
man1 <- man1[1:17,]

uni1 <- Away_Function("Man United")
uni1$Date <- as.Date(uni1$Date, "%d/%m/%y")
uni1 <- uni1[1:17,]

plot01 <- ggplot(man1) +
  geom_point(aes(Date, outcome, color=outcome)) + ggtitle("Man City")
plot02 <- ggplot(uni1) +
  geom_point(aes(Date, outcome, color=outcome)) + ggtitle("Man United")
plot_grid(plot01, plot02, labels="AUTO", ncol=1)

```
The exploratory plot above, plot A, shows the outcomes of matches for Manchester City as the home team in the 2011-2012 season. Specifically, it includes all of Man City's home games leading up to the match that they played against Manchester United as the away team on April 30, 2012. The outcomes of the matches are measured as a win (three points), loss (one point) or draw (zero points). Manchester City won the vast majority of those matches and had very few losses. It doesn't appear Man City had any draws. The exploratory plot above, plot B, shows the outcomes of matches for Manchester United as the away team in the 2011-2012 season leading up to the team's match at Manchester City on April 30, 2012. Man United won most of those matches, had some losses and very few draws.


## Prediction for Match
Predictions are in terms of the home team   
Actual result was a home win (1-0)

```{r pred0, echo=FALSE}
# Takes a couple minutes to run
Match356 <- mc_funct(match_id=356, home_team="Man City", away_team="Man United")
res356 <- table(t(Match356$ResultH))
res356 <- as.data.frame(res356)
res356$Percent <- res356$Freq/100000 * 100
order <- c("Win", "Loss", "Draw")
res356 <- res356 %>%
  slice(match(Var1, order))
colnames(res356) <- c("Match Result", "Occurances", "Percent")
res356$"Article Result" <- c(51.589, 22.779, 25.632)
res356
```
found the 
The results of the article differ slightly from the results we found. This is likely due to the randomness of sampling, as well as the increased number of simulations the paper ran.
compare this table to one in article 

# Further Exploration

## Chelsea (Home) vs Liverpool (Away) 5/10/2015

### Exploratory Plot of Outcomes Before Match

```{r graph1, echo=FALSE}
chel <- Home_Function("Chelsea")
chel$Date <- as.Date(chel$Date, "%d/%m/%y")
chel <- chel[1:74,]

liv <- Away_Function("Liverpool")
liv$Date <- as.Date(liv$Date, "%d/%m/%y")
liv <- liv[1:74,]

plot1 <- ggplot(chel) +
  geom_point(aes(Date, outcome, color=outcome)) + ggtitle("Chelsea")
plot2 <- ggplot(liv) +
  geom_point(aes(Date, outcome, color=outcome)) + ggtitle("Liverpool")
plot_grid(plot1, plot2, labels="AUTO", ncol=1)
```

### Prediction for Match
Predictions are in terms of the home team   
Actual result was a draw

```{r pred, echo=FALSE}
# Takes a couple minutes to run
set.seed(400)
Match1497 <- mc_funct(match_id=1497, home_team="Chelsea", away_team="Liverpool")
res1497 <- table(t(Match1497$ResultH))
res1497 <- as.data.frame(res1497)
res1497$Percent <- res1497$Freq/100000 * 100
order <- c("Win", "Loss", "Draw")
res1497 <- res1497 %>%
  slice(match(Var1, order))
colnames(res1497) <- c("Match Result", "Occurances", "Percent")
res1497
```

## Manchester City (Home) vs Newcastle (Away) 8/19/2013

### Exploratory Plot of Outcomes Before Match

```{r graph2, echo=FALSE}
man <- Home_Function("Man City")
man$Date <- as.Date(man$Date, "%d/%m/%y")
man <- man[1:38,]

new <- Away_Function("Newcastle")
new$Date <- as.Date(new$Date, "%d/%m/%y")
new <- new[1:38,]

plot3 <- ggplot(man) +
  geom_point(aes(Date, outcome, color=outcome)) + ggtitle("Manchester City")
plot4 <- ggplot(new) +
  geom_point(aes(Date, outcome, color=outcome)) + ggtitle("Newcastle")
plot_grid(plot3, plot4, labels="AUTO", ncol=1)
```
The exploratory plot above, plot A, shows the outcomes of matches for Manchester City as the home team in the 2013-2014 season. Specifically, it includes all of Man City's home games leading up to the match that they played against Newcastle as the away team on August 19, 2013. Manchester City won the vast majority of those matches and had very few losses and even less draws. The exploratory plot above, plot B, shows the outcomes of matches for Newcastle as the away team in the 2011-2012 season leading up to the team's match at and against Man City on August 19, 2013. Newcastle won most of those matches, had some losses and very few draws. 


### Prediction for Match
Predictions are in terms of the home team   
Actual result was a home win

```{r pred2, echo=FALSE}
# Takes a couple minutes to run
Match770 <- mc_funct(match_id=770, home_team="Man City", away_team="Newcastle")
res770 <- table(t(Match770$ResultH))
res770 <- as.data.frame(res770)
res770$Percent <- res770$Freq/100000 * 100
order <- c("Win", "Loss", "Draw")
res770 <- res770 %>%
  slice(match(Var1, order))
colnames(res770) <- c("Match Result", "Occurances", "Percent")
res770
```

## Tottenham (Home) vs Aston Villa (Away) 04/11/2015

### Exploratory Plot of Outcomes Before Match

```{r graph3, echo=FALSE}
tott <- Home_Function("Tottenham")
tott$Date <- as.Date(tott$Date, "%d/%m/%y")
tott <- tott[1:73,]

av <- Away_Function("Aston Villa")
av$Date <- as.Date(av$Date, "%d/%m/%y")
av <- av[1:73,]

p1 <- ggplot(tott) +
  geom_point(aes(Date, outcome, color=outcome)) + ggtitle("Tottenham")
p2 <- ggplot(av) +
  geom_point(aes(Date, outcome, color=outcome)) + ggtitle("Aston Villa")
plot_grid(p1, p2, labels="AUTO", ncol=1)
```

The exploratory plot above, plot A, shows the outcomes of matches for Tottenham as the home team in the 2014-2015 season. Specifically, it includes all of Tottenham's home games leading up to the match that they played against Aston Villa as the away team on April 11, 2015. Tottenham won the vast majority of those matches and had very few losses and draws. The exploratory plot above, plot B, shows the outcomes of matches for Aston Villa as the away team in the 2014-2015 season leading up to the team's match at and against Tottenham on April 11, 2015. Aston Villa won some of its matches, but its matches mainly resulted in draws and losses. 


### Prediction for Match
Predictions are in terms of the home team   
Actual result was a home loss

```{r pred3, echo=FALSE}
# Takes a couple minutes to run
Match3151 <- mc_funct(match_id=3151, home_team="Tottenham", away_team="Aston Villa")
res3151<- table(t(Match3151$ResultH))
res3151 <- as.data.frame(res3151)
res3151$Percent <- res3151$Freq/100000 * 100
order <- c("Win", "Loss", "Draw")
res3151 <- res3151 %>%
  slice(match(Var1, order))
colnames(res3151) <- c("Match Result", "Occurances", "Percent")
res3151
```

# Estimating final season ranking

```{r}
teams1415 <- unique(S14_15$HomeTeam)
S14_15$HomePoints <- rep(NA, length(S14_15$Date))
S14_15$AwayPoints <- rep(NA, length(S14_15$Date))
for(i in 1:length(S14_15$HomePoints)){
  if(S14_15$FTR[i] == "H"){
    S14_15$HomePoints[i] <- 3
    S14_15$AwayPoints[i] <- 0
  }
  if(S14_15$FTR[i] == "A"){
    S14_15$HomePoints[i] <- 0
    S14_15$AwayPoints[i] <- 3
  }
  if(S14_15$FTR[i] == "D"){
    S14_15$HomePoints[i] <- 1
    S14_15$AwayPoints[i] <- 1
  }
}
head(S14_15)
hpts <- S14_15 %>%
  group_by(HomeTeam) %>%
  summarise(HomePoints = sum(HomePoints))

apts <- S14_15 %>%
  group_by(AwayTeam) %>%
  summarise(AwayPoints = sum(AwayPoints))

tpts <- cbind(apts, hpts)

tpts$TotalPoints <- tpts$AwayPoints + tpts$HomePoints
tpts

tpts <- tpts[order(-tpts$TotalPoints),]
```

```{r}
#match 1501
set.seed(400)
Match1501 <- mc_funct(match_id = 1501, home_team = "Liverpool", away_team = "Crystal Palace")
res1501<- table(t(Match1501$ResultH))
res1501 <- as.data.frame(res1501)
res1501$Percent <- res1501$Freq/100000 * 100
order <- c("Win", "Loss", "Draw")
res1501 <- res1501 %>%
  slice(match(Var1, order))
colnames(res1501) <- c("Match Result", "Occurances", "Percent")
res1501
```

```{r}
#match 1520
set.seed(400)
Match1520 <- mc_funct(match_id = 1520, home_team = "Stoke", away_team = "Liverpool")
res1520<- table(t(Match1520$ResultH))
res1520 <- as.data.frame(res1520)
res1520$Percent <- res1520$Freq/100000 * 100
order <- c("Win", "Loss", "Draw")
res1520 <- res1520 %>%
  slice(match(Var1, order))
colnames(res1520) <- c("Match Result", "Occurances", "Percent")
res1520
```

```{r}
# win all three
www <- .51999*.45705*.44566

# win, win, lose
wwl <- .51999*.45705*.36241

# win, win, draw
wwd <- .51999*.45705*.19193

# win, lose, win
wlw <- .51999*.31466*.44566

# win, draw, win
wdw <- .51999*.22829*.44566

# win, draw, lose
wdl <- .51999*.22829*.36241

# win, lose, draw
wld <- .51999*.31466*.19193

# win, draw, draw
wdd <- .51999*.22829*.19193

# win, lose, lose
wll <- .51999*.31466*.36241



# lose, win, win
lww <- .2918*.45705*.44566

# lose, win, lose
lwl <- .2918*.45705*.36241

# lose, win, draw
lwd <- .2918*.45705*.19193

# lose, lose, win
llw <- .2918*.31466*.44566

# lose, draw, win
ldw <- .2918*.22829*.44566

# lose, draw, lose
ldl <- .2918*.22829*.36241

# lose, lose, draw
lld <- .2918*.31466*.19193

# lose, draw, draw
ldd <- .2918*.22829*.19193

# lose, lose, lose
lll <- .2918*.31466*.36241




# draw, win, win
dww <- .18821*.45705*.44566

# draw, win, lose
dwl <- .18821*.45705*.36241

# draw, win, draw
dwd <- .18821*.45705*.19193

# draw, lose, win
dlw <- .18821*.31466*.44566

# draw, draw, win
ddw <- .18821*.22829*.44566

# draw, draw, lose
ddl <- .18821*.22829*.36241

# draw, lose, draw
dld <- .18821*.31466*.19193

# draw, draw, draw
ddd <- .18821*.22829*.19193

# draw, lose, lose
dll <- .18821*.31466*.36241

probdf <- data.frame(ddd, ddl, ddw, dld, dll, dlw, dwd, dwl, dww, ldd, ldl, ldw, lld, lll, llw, lwd, lwl, lww, wdd, wdl, wdw, wld, wll, wlw, wwd, wwl, www)

probpoints <- c(3, 2, 5, 2, 1, 4, 5, 4, 7, 2, 1, 4, 1, 0, 3, 4, 3, 6, 5, 4, 7, 4, 3, 6, 7, 6, 9)

probdf <- rbind(probdf, probpoints)

for(i in 1:ncol(probdf)){
  if(probdf[2, i] < 3){
    r6[i] <- sum(probdf[1, i])
  }
  if(probdf[2, i] > 3 & probdf[2, i] < 9){
    r5[i] <- sum(probdf[1, i])
  }
  if(probdf[2, i] == 3){
    rt5[i] <- sum(probdf[1, i])
  }
  if(probdf[2, i] == 9){
    rt4[i] <- sum(probdf[1, i])
  }
}

r5 <- na.omit(r5)
r6 <- na.omit(r6)
rt4 <- na.omit(rt4)
rt5 <- na.omit(rt5)

resdf <- data.frame("Rank 5" = sum(r5), "Rank 6" = sum(r6), "Rank T4" = sum(rt4), "Rank T5" = sum(rt5))

knitr::kable(resdf, caption = "Ranking Probabilities for Liverpool", "pipe", digits = 5)
```


Using the Monte Carlo simulation method that we had used for predicting outcomes of a few matches, the next step was to try and estimate a team's final ranking. The team we chose to do this estimate for was Liverpool. When looking at the actual final rankings of the teams, it seemed uncontested that Chelsea would end up ranking first which is why we ended up choosing Liverpool.
In order to get the final ranking, we first conducted the Monte Carlo simulation on the Chelsea versus Liverpool match we had picked for the last step. We then ran this simulation two more times on the matches Liverpool had left in their season. Once we had these results we could look into the probabilities of each final ranking for Liverpool. In order to figure out the other team's final rankings, we took the results of all of their home and away games and converted them to points depending on that result, 3 for a win, 1 for a draw, and 0 for a loss. Once converted to points, we were able to add up the total amount of points for each team and sort them to see each teams actual final ranking from the 2014-15 season. Since we knew all of the other team's final rankings, we were able to fit Liverpool into the results where they belonged based on the Monte Carlo results.
The table above shows the probability of each possible ranking for Liverpool based on their previous matches in the season and the Monte Carlo simulations. The overall probabilities of all possible scenarios for Liverpool's final three games based on our simulations were calculated. Then based on these probabilities, the total amount of possible points for those last three games was calculated. This total was then added to Liverpool's point total from their previous games in the season. If the point value of the final three games was less than 3, Liverpool would be ranked 6th. If the point value was between 3 and 9, they would be ranked 5th. If the point value was exactly 3, they would end up tying for 5th, which would cause the rank to be determined by some other factor which we do not have the data for. Finally, if the point value was exactly 9, they would end up tying for 4th. The probabilities of each of these scenarios were calculated and the most likely result was that they would end up ranking 5th with a probability of about 68.719%. In the actual results, they ended up placing 6th, which our simulation said would only happen with a probability of 16.95%.

# References 

"Data Files: England". *Football-Data.co.uk*, 15 December 2021, http://www.football-data.co.uk/englandm.php
Lahvička, Jiří. “Using Monte Carlo Simulation to Calculate Match Importance: The Case of English Premier League.” Journal of Sports Economics, vol. 16, no. 4, May 2015, pp. 390–409, doi:10.1177/1527002513490172.

